<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>DBMSデータサーチ(仮)</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      display: flex;
    }
    .left-panel {
      width: 40%;
      padding: 10px;
      border-right: 2px solid #ccc;
    }
    .right-panel {
      width: 60%;
      padding: 10px;
      /* テーブルだけ横スクロール */
      overflow-x: auto;
    }
    .pedigree {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
      margin-bottom: 20px;
    }
    .pedigree td {
      border: 1px solid black;
      padding: 5px;
    }
    .horse select {
      width: 100%;
    }
    #dataTable {
      width: 100%;
      min-width: 800px;
    }
    thead select {
      width: 100%;
      box-sizing: border-box;
    }
    .dataTable {
      width: 100%;
    }
  </style>
</head>
<body>
  <h2>DBMSデータサーチ(仮)</h2>
  <div class="container">
    <!-- 左パネル：血統表や親系統など -->
    <div class="left-panel">
      <h3>血統表 (例)</h3>
      <table class="pedigree">
        <tbody>
          <tr>
            <td rowspan="8">父</td>
            <td class="horse" colspan="4"></td>
          </tr>
          <!-- 以降省略 -->
        </tbody>
      </table>
    </div>

    <!-- 右パネル：DataTable -->
    <div class="right-panel">
      <h3>CSVデータ</h3>
      <p>同じディレクトリに <code>DBMSdata_20250210.csv</code> がある前提で、fetchします。</p>
      <table id="dataTable" class="display dataTable">
        <thead>
          <!-- JSで生成 -->
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // GitHub Pagesで同階層 mydata.csv を読み込む例
    const CSV_URL = "./DBMSdata_20250210.csv"; // 同じフォルダにmydata.csvを置く

    let table;
    let columnMap = {};
    let originalData = [];

    // 右テーブル2行目の<select>でフィルタしたい列
    const filterHeaders = [
      "系統","category","距離","成長","ダート",
      "体質","気性","実績","底力","安定","天性"
    ];

    document.addEventListener("DOMContentLoaded", () => {
      console.log("DOM Loaded. Attempting to fetch CSV:", CSV_URL);

      fetch(CSV_URL)
        .then(res => {
          if(!res.ok) {
            throw new Error("HTTP error, status=" + res.status);
          }
          return res.text();
        })
        .then(csvText => {
          console.log("CSV fetch成功:", csvText.substring(0,100) + "...");
          parseCSVAndInit(csvText);
        })
        .catch(err => {
          console.error("CSV読み込み失敗:", err);
        });
    });

    function parseCSVAndInit(csvText){
      const lines = csvText.split("\\n").map(line => line.split(",").map(c => c.trim()));
      const headerRow = lines[0];
      const dataRows = lines.slice(1).filter(row => row.length === headerRow.length);

      console.log("Header:", headerRow);
      console.log("Rows:", dataRows.length, "行");

      // 1行目:列名
      let firstRow = "<tr>" + headerRow.map(h => `<th>${h}</th>`).join("") + "</tr>";
      // 2行目: filterHeaders に含まれる列だけ <select>
      let secondRow = "<tr>" + headerRow.map(h => {
        if(filterHeaders.includes(h)) {
          return `<th class='colfilter' data-col='${h}'><select><option value=''>すべて</option></select></th>`;
        } else {
          return `<th></th>`;
        }
      }).join("") + "</tr>";

      document.querySelector("#dataTable thead").innerHTML = firstRow + secondRow;

      // columnMap
      headerRow.forEach((col, i) => {
        columnMap[col] = i;
      });
      originalData = dataRows;

      // DataTables再生成
      if($.fn.DataTable.isDataTable("#dataTable")) {
        $("#dataTable").DataTable().destroy();
      }
      table = $("#dataTable").DataTable({
        data: dataRows,
        columns: headerRow.map(h => ({ title: h })),
        scrollX: true,
        orderCellsTop: true
      });

      // 2行目の<select>に選択肢を入れる
      populateColumnFilters(headerRow, dataRows);

      // 2行目<select>でフィルタ
      document.querySelectorAll(".colfilter select").forEach(sel => {
        sel.addEventListener("change", onChangeHeaderSelect);
      });
    }

    function populateColumnFilters(headerRow, dataRows){
      headerRow.forEach(colName => {
        if(!filterHeaders.includes(colName)) return;
        let colIndex = columnMap[colName];
        if(colIndex === undefined) return;

        let uniqueVals = [...new Set(dataRows.map(r => r[colIndex]))].sort();
        let th = document.querySelector(`.colfilter[data-col='${colName}']`);
        if(!th) return;
        let sel = th.querySelector("select");
        if(!sel) return;

        let opts = "<option value=''>すべて</option>" +
          uniqueVals.map(v => `<option value=\"${v}\">${v}</option>`).join("");
        sel.innerHTML = opts;
      });
    }

    function onChangeHeaderSelect(){
      const selects = document.querySelectorAll(".colfilter select");
      selects.forEach(sel => {
        let colName = sel.parentElement.getAttribute("data-col");
        let colIndex = columnMap[colName];
        if(colIndex === undefined) return;
        let val = sel.value;
        if(val){
          table.column(colIndex).search(`^${val}$`, true, false);
        } else {
          table.column(colIndex).search("");
        }
      });
      table.draw();
    }
  </script>
</body>
</html>
